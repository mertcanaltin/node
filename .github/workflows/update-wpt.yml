name: WPT update
on:
  schedule:
    # Run once a week at 12:00 AM UTC on Sunday.
    - cron: 0 0 * * *

  workflow_dispatch:

permissions:
  contents: read

jobs:
  wpt-update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332  # v4.1.7
        with:
          persist-credentials: false
      - name: Clone WPT Repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332  # v4.1.7
        with:
          repository: web-platform-tests/wpt
          path: test/fixtures/wpt
          sparse-checkout: |
            common/ eventsource/ fetch/ interfaces/ mimesniff/ resources/ service-workers/ storage/ websockets/ xhr/ LICENSE.md
          persist-credentials: false
      - name: Move WPT Files
        run: |
          rm -rf test/fixtures/wpt/.git
          echo "NEW_VERSION=$(git rev-parse --short HEAD)" >> "$GITHUB_ENV"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_USER_TOKEN }}
      - name: Create PR with first commit
        if: env.NEW_VERSION
        uses: gr2m/create-or-update-pull-request-action@77596e3166f328b24613f7082ab30bf2d93079d5
        # Creates a PR with the new WPT source code committed
        env:
          GITHUB_TOKEN: ${{ secrets.GH_USER_TOKEN }}
        with:
          author: Node.js GitHub Bot <github-bot@iojs.org>
          body: This is an automated update of the WPT to ${{ env.NEW_VERSION }}.
          branch: actions/update-wpt  # Custom branch *just* for this Action.
          commit-message: 'test: update WPT to ${{ env.NEW_VERSION }}'
          labels: test
          title: 'test: update WPT to ${{ env.NEW_VERSION }}'
          update-pull-request-title-and-body: true
      - name: Add second commit
        # Adds a second commit to the PR with any additional updates if needed
        if: env.NEW_VERSION
        uses: gr2m/create-or-update-pull-request-action@77596e3166f328b24613f7082ab30bf2d93079d5
        env:
          GITHUB_TOKEN: ${{ secrets.GH_USER_TOKEN }}
        with:
          author: Node.js GitHub Bot <github-bot@iojs.org>
          branch: actions/update-wpt  # Custom branch *just* for this Action.
          commit-message: 'test: additional updates for WPT-${{ env.NEW_VERSION }}'
          labels: test
